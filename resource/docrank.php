<?php// This file is part of Moodle - http://moodle.org///// Moodle is free software: you can redistribute it and/or modify// it under the terms of the GNU General Public License as published by// the Free Software Foundation, either version 3 of the License, or// (at your option) any later version.//// Moodle is distributed in the hope that it will be useful,// but WITHOUT ANY WARRANTY; without even the implied warranty of// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the// GNU General Public License for more details.//// You should have received a copy of the GNU General Public License// along with Moodle.  If not, see <http://www.gnu.org/licenses/>./** * DocRank is a plugin for Moodle v2.0 that counts the clicks documents * recieve and displays them in a chart.  * * RememberMe is a block type plugin for Moodle v2.0 made by students of the * Berlin School of Economics and Law and meant to be used by schools and * learning groups. It collects data on how often documents are viewed within * a course and visualises the result as a chart. This enables ranking of a * document's popularity and importance, urging users to read certain documents * or pay closer attention to them. The chart features various filters and * sortings. * * @package    moodle-block_DocRank * @category   block-plugin * @copyright  2016 ProPlug * @license *//* defining PHP errorstatement */ error_reporting(E_ALL | E_STRICT);ini_set('display_errors', 1);/* Width of the chart (px) */$chartWidth = 800;/* Hight of the chartrows (px) */$rowHeight = 40;/* Set startingvalue for the maximum value of the x-axis  */$xaxisMax = 10;/* Set intervall for the x-Axis */$xaxisInterval = 10;/* Filter input of the forms and set variables */if(isset($_REQUEST['courseid'])){    $courseId = filter_var($_REQUEST['courseid']);}else{    $courseId = NULL;}if(isset($_REQUEST['sort'])){    $sort = filter_var($_REQUEST['sort']);}else{    $sort = NULL;}if(isset($_REQUEST['limiter'])){    $limiter = filter_var($_REQUEST['limiter']);  }else{    $limiter = NULL;}if(isset($_REQUEST['order'])){    $order = filter_var($_REQUEST['order']);  }else{    $order = NULL;}/* Exit if there is no courseID */if($courseId == NULL){        exit("Error: no course id!");}/* insert Moodle Config */ require_once('../../../config.php');/* Grant access only for logged in course members */ require_course_login($courseId);/* "Import" global variables from the Moodle Config (config.php) */global $COURSE;global $DB;    global $CFG; /* Set sorting sequence*/ if ($sort == "Klicks"){    $orderBy = "counter";}elseif($sort == "Date"){    $orderBy = "timemodified";}else{    $orderBy = "counter";}            /* Set standard limit in case that there is no input */ if ($limiter == NULL){    $limiter = 5;}            /* Set descending as standard */ if ($order == NULL){    $orderType = 'DESC';}else{    $orderType = $order;}/* SQL-query for counting records */$sqlCount = '                        SELECT count(*) AS count FROM            (SELECT contextid, courseid, objectid, count(*) AS counter FROM {logstore_standard_log} WHERE action = :action AND target = :target GROUP BY courseid, objectid) logs            JOIN(            SELECT contextid, component, filearea, itemid, filename FROM {files} WHERE filename != ".") files ON logs.contextid = files.contextid             JOIN(            SELECT id FROM {course}) course ON logs.courseid = course.id            JOIN(            SELECT mdl_resource.id, name, timemodified FROM {resource}) docs ON logs.objectid = docs.id WHERE courseid = :courseid ';/* perform SQL-Query */$countRecord = $DB->get_record_sql($sqlCount, array('action' => 'viewed', 'target' => 'course_module', 'courseid' => $courseId));/* total number of records */$overallCount = $countRecord->count;if($overallCount == NULL) {    /* Exit if there ist no record */    exit("Error: There is no data available.");}/* Prepare SQL-query for getting records */$sqlGet = '            SELECT docs.id, files.contextid, files.component, files.filearea, files.itemid, files.filename, name, counter, timemodified FROM            (SELECT contextid, courseid, objectid, count(*) AS counter FROM {logstore_standard_log} WHERE action = :action AND target = :target GROUP BY courseid, objectid) logs            JOIN(            SELECT contextid, component, filearea, itemid, filename FROM {files} WHERE filename != ".") files ON logs.contextid = files.contextid             JOIN(            SELECT id FROM {course}) course ON logs.courseid = course.id            JOIN(            SELECT mdl_resource.id, name, timemodified FROM {resource}) docs ON logs.objectid = docs.id WHERE courseid = :courseid             ORDER BY ' . $orderBy . ' ' . $orderType . ', name '. $orderType . ' ';/* perform SQL-Query */$mysqlRecords = $DB->get_records_sql($sqlGet, array('action' => 'viewed', 'target' => 'course_module', 'courseid' => $courseId), 0, $limiter);/* If records available */if($mysqlRecords != NULL) {       /* Count records */    $dataCount = count($mysqlRecords);    /* If limit is less than records */    if($dataCount < $limiter){        /* Height of the chart is records * row-height */        $chartHeight = $dataCount * $rowHeight;    }    else{        /* Height of the chart is limit * row-height */        $chartHeight = $limiter * $rowHeight;    }    /* declare Variable */    $diagramData = NULL;    foreach ($mysqlRecords as $row) {            $limitCounter++;        /* If klicks greater than value of the x-Axis */        if($row->counter > $xaxisMax){                        /* Set max value of the x-Axis to count of klicks */            $xaxisMax = $row->counter;                        /* Get modulo 10 of the X-axis */            $mod = $xaxisMax % 10;                        /* If modulo >0 */            if($mod != 0){                                /* Add next multiple value of 10 to the value of the x-axis (for tens steps in the chart) */                $xaxisMax = $xaxisMax + (10 - $mod);            }        }        /* build link for file */                  $fileLink = "$CFG->wwwroot/pluginfile.php/$row->contextid/$row->component/$row->filearea/$row->itemid/$row->filename";            /* Fill array with the chart data */                        $diagramData[] = json_encode(array($row->counter, '<a href="'.$fileLink.'" target="_blank" class="link"><b>'.$row->name.'</b> (id: '.$row->id.') - '.  date("d.m.Y", $row->timemodified).'</b>', $fileLink));    }}else {    /* Exit if there ist no record */    exit("Error: There is no data available.");}?><!DOCTYPE html><html>    <!-- Header-Part: Inforfation, Not shown in browser -->    <head>        <meta name="creator" content="Projekt-VI2015">        <meta name="description" content="DocRank">        <meta name="keywords" content="">        <title>DocRank</title>        <!-- CSS-Link -->        <link rel="stylesheet" href="docrank.css">        <!-- Links for Chart-code -->        <link class="include" rel="stylesheet" type="text/css" href="dist/jquery.jqplot.min.css" />        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>        <script class="include" type="text/javascript" src="dist/jquery.jqplot.min.js"></script>        <script class="include" language="javascript" type="text/javascript" src="dist/plugins/jqplot.barRenderer.min.js"></script>        <script class="include" language="javascript" type="text/javascript" src="dist/plugins/jqplot.categoryAxisRenderer.min.js"></script>        <!-- Following classes are needed for mouseover-functions -->        <script class="include" type="text/javascript" src="dist/plugins/jqplot.dateAxisRenderer.min.js"></script>        <script class="include" type="text/javascript" src="dist/plugins/jqplot.cursor.min.js"></script>        <script class="include" type="text/javascript" src="dist/plugins/jqplot.highlighter.min.js"></script>                <!--Functions to save pressed arrow in a variable and change color of the arrow -->        <script>            fktClick = function(p) {                if (p === 'up'){                    document.getElementById("up").src = "arrow_red_up.jpg";                    document.getElementById("down").src = "arrow_black_down.jpg";                    document.getElementById("orderid").value = "ASC";                }                else if (p === 'down'){                    document.getElementById("down").src = "arrow_red_down.jpg";                    document.getElementById("up").src = "arrow_black_up.jpg";                    document.getElementById("orderid").value = "DESC";                }            }                        function openLink(url) {              var newTab = window.open(url, '_blank');              newTab.focus();            }                    </script>		    </head>    <!-- Body-part: Visible content in the browser window -->    <body bgcolor="white" text="orange" link="yellow" alink="blue" vlink="red" align="middle">          <!--Banner -->          <ul class="banner_background">        </ul>        <ul class="banner">            <ul class="bannerl">                <h1>DocRank</h1>            </ul>            <ul class="bannerr">                <img align="right" src="logo.jpg" width="310" height="80">            </ul>        </ul>        <!--Navigation -->        <ul class ="navigation_background">        </ul>        <ul class="navigation">            <!-- Form to filter visible contents -->            <form  action="" method="post" onsubmit="return pruefe(this)">                <!-- Dropdown-menu to choose the munber of shown documents -->                <font color="black" face="Arial" size="2">Number of documents</font>                <select name="limiter">                    <?php                    /*  Startingpoint für count */                    $steps = 5;                                        /* build option to choose limit */                    for($i = 1; $i <= $overallCount; $i++) {                                                /* If Modulo of $i and $steps is 0 */                        if($i % $steps == 0){                                                        /* If counter = set limit */                            if($i == $limiter) {                                                                /* Print field as chosen */                                print '<option selected="true">' . $i . '</option>';                            }                            else {                                                                /* Print field as "normal" */                                print '<option>' . $i . '</option>';                            }                                                        }                        else{                                                        /* If counter = count of all records */                            if($i == $overallCount){                                                                /* If Counter = set limit */                                if($i == $limiter) {                                                                        /* Print field as chosen */                                    print '<option selected="true">' . $i . '</option>';                                }                                else {                                                                        /* Print field as "normal" */                                    print '<option>' . $i . '</option>';                                }                                                                   }                        }                    }                                    ?>                </select>                               <input type="hidden" name="courseid" value="<?php print $courseId /* Print courseId */ ?>"/> 	                <font color="black" face="Arial" size="2">Order by:</font>                <select name="sort">                    <?php                     /* Show actual sequence as chosen in form*/                    if($orderBy == "timemodified"){                        print '<option value="Klicks">Clicks</option>';                        print '<option selected value="Date">Date</option>';                    }                    else{                        print '<option selected value="Klicks">Clicks</option>';                        print '<option value="Date">Date</option>';                    }                    ?>                                                        </select>                <input type="hidden" name="order" value="<?php print $orderType /* Print actual sequence */?>" id="orderid"/>                <!-- Clickable arrows to choose direction of order -->                <img id="up" src="arrow_black_up.jpg" width="10" height="10" alt="arrow_black_up" onclick="fktClick('up')"/>                <img id="down" src="arrow_red_down.jpg" width="10" height="10" alt="arrow_black_down" onclick="fktClick('down')"/>                <!-- Button to submit form and refresh contents -->                <input type="submit" value="Refresh"  onclick="pruefe(this.form)">            </form>        </ul>        <!-- Chart-part -->        <div class="hauptteil" align="center">            <?php            /* JS function to set the marks of ascending/descending arrow */            print "<script>";            if ($orderType == 'ASC') {                print "fktClick('up');";            }            else {                print "fktClick('down');";            }            print "</script>";            ?>            <div>                <!-- Headline of the chart -->                <h2>                                    <?php print $COURSE->fullname; /* Print course name */?>                </h2>            </div>            <div id="chart" style="<?php print 'width: '.$chartWidth.'px; height: '.$chartHeight.'px;'; /* Print width and height of the chart */ ?>"></div>            <!-- Chart-Code in Javascript -->            <script class="code" type="text/javascript">                $(document).ready(function() {                    //this.sortData = false;                    // enables Plugins like Mouseover-functionality                     $.jqplot.config.enablePlugins = true;                                        var plot = $.jqplot('chart', [                        [                        <?php                        /* Print chart data*/                        $diagramData = array_reverse($diagramData);                        foreach ($diagramData as $row) {                            print "$row,";                        }                        ?>                        ]                    ], {                                        height: <?php print $chartHeight; /* Print hight of the chart */ ?>,                    width: <?php print $chartWidth; /* Print width of the chart */ ?>,                    animate: !$.jqplot.use_excanvas,                    seriesColors: ['#ff0000'],                    seriesDefaults: {                                                // Set charttype = Barchart                        renderer: $.jqplot.BarRenderer,                        pointLabels: {show: true},                        // Rotate Bar shaddows => light from top-right corner.                        shadowAngle: 135,                        // chart will be rendered horizontally.                        rendererOptions: {                            barDirection: 'horizontal',                            barWidth: 25                        }                    },                                           axes: {                                                 yaxis: {                            renderer: $.jqplot.CategoryAxisRenderer                        },                        xaxis: {                                                        min: 0,                            max: <?php print $xaxisMax; /* Print max value of the x-Axis */ ?>,                            tickInterval: <?php print $xaxisInterval ; /* Print max value of the x-Axis */ ?>,                            formatString: '%d'                                                        }                                           },                     highlighter: {                                                tooltipAxes: 'x',                        yvalues: 1,                        formatString: '<div class="jqplot-highlighter">Clicks: %s</div>'                    },                    cursor: {                                                showTooltip: false                    }                                                             });                $('#chart').bind('jqplotDataClick',                     function (ev, seriesIndex, pointIndex, data) {                        openLink(data[2]);                    }                );                               });            </script>        </div>    </body></html>